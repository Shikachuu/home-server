variant: fcos
version: 1.4.0
passwd:
  users:
    - name: core
      password_hash: $y$j9T$CGV9PTNv1e/4qJQfGF2rg/$AXgFPI9l5G4sxBeJA0XiY2VwbhFn48PncZgoNjJjxU5
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJ9B6zMB/ycG9cMfWtwIT/9mWaNGv7nu+h5nrHJ4drkl shika@pop-os
systemd:
  units:
    - name: sshd.service
      enabled: true
    - name: rebootmgr.service
      enabled: true
    - name: blocky.service
      enabled: true
      contents: |
        [Unit]
        Description=Blocky DNS server
        After=network-online.target
        Wants=network-online.target

        [Service]
        TimeoutStartSec=0
        ExecStartPre=-/bin/podman kill blocky
        ExecStartPre=-/bin/podman rm blocky
        ExecStartPre=/bin/podman pull ghcr.io/0xerr0r/blocky:latest
        ExecStart=/bin/podman run --name blocky -v /etc/blocky-config.yaml:/app/config.yml -p 80:80 -p 53:53/tcp -p 53:53/udp ghcr.io/0xerr0r/blocky:latest

        [Install]
        WantedBy=multi-user.target
storage:
  links:
    - path: /etc/localtime
      target: ../usr/share/zoneinfo/Europe/Budapest
  files:
    - path: /etc/blocky-config.yaml
      overwrite: true
      contents:
        inline: |
          upstream:
            default:
              - tcp-tls:dot.libredns.gr:853
              - https://doh.libredns.gr/dns-query
              - https://fi.doh.dns.snopyta.org/dns-query
              - tcp-tls:fi.dot.dns.snopyta.org
          blocking:
            blackLists:
              ads:
                - https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts
                - https://dbl.oisd.nl/
                - https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt
                - https://raw.githubusercontent.com/hufilter/hufilter/master/hufilter-dns.txt
            clientGroupsBlock:
              default:
                - ads
          customDNS:
            rewrite:
              home: local
              lan: local
            mapping:
              dns.local: 192.168.0.20
              picloud.local: 192.168.0.10
          port: 53
          httpPort: 80
          logLevel: error
          logFormat: json
          logPrivacy: true
          prometheus:
            enable: true
            path: /metrics
    - path: /etc/hostname
      mode: 0644
      overwrite: true
      contents:
        inline: raspi3b
    - path: /etc/ssh/sshd_config.d/20-enable-passwords.conf
      mode: 0644
      contents:
        inline: |
          # MicroOS disables SSH password login by default.
          # Enable it.
          # This file must sort before 40-disable-passwords.conf.
          PasswordAuthentication yes
    - path: /etc/rebootmgr.conf
      overwrite: true
      contents:
        inline: |
          [rebootmgr]
          window-start=02:30
          window-duration=1h
          strategy=maint-window
